<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculateur Plan d'Audit (v3.1 - PDF)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #eff6ff;
      --secondary: #f97316;
      --secondary-light: #fff7ed;
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --text-light: #64748b;
      --success: #22c55e;
      --danger: #ef4444;
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 2rem 1rem;
      line-height: 1.5;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    /* Header & Stats Bar */
    .header-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-box {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
      text-align: center;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-light);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-val {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
      margin-top: 0.25rem;
    }

    .stat-val.terrain {
      color: var(--secondary);
    }

    .stat-box.success {
      border: 2px solid var(--success);
      background: #f0fdf4;
    }

    .stat-box.success .stat-val {
      color: var(--success);
    }

    .stat-box.error {
      border: 2px solid var(--danger);
      background: #fef2f2;
    }

    .stat-box.error .stat-val {
      color: var(--danger);
    }

    /* Configuration */
    .config-bar {
      background: var(--surface);
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .config-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .config-input {
      padding: 0.5rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1.1rem;
      width: 100px;
      font-weight: bold;
      text-align: center;
      color: var(--primary);
    }

    .config-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* View Controls */
    .view-controls {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .text-btn {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .text-btn:hover {
      background: #e2e8f0;
      color: var(--text);
    }

    /* Day Card */
    .day-card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      overflow: hidden;
      transition: all 0.2s;
      page-break-inside: avoid;
      /* Print optimization */
    }

    .day-header {
      background: var(--surface);
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .day-header:hover {
      background: #f8fafc;
    }

    .day-title-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .day-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }

    .day-fraction {
      font-size: 0.85rem;
      color: var(--text-light);
      background: #f1f5f9;
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
    }

    .day-summary {
      display: flex;
      gap: 1.5rem;
      font-size: 0.9rem;
      color: var(--text-light);
      margin-right: 1rem;
    }

    .day-summary strong {
      color: var(--text);
      font-weight: 600;
    }

    .chevron {
      transition: transform 0.2s;
      color: var(--text-light);
    }

    .day-card.open .chevron {
      transform: rotate(180deg);
    }

    .day-body {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: none;
      background: #fafafa;
    }

    .day-card.open .day-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    @media (max-width: 768px) {
      .day-card.open .day-body {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
    }

    /* Period Section */
    .period-block {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .period-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-light);
      text-transform: uppercase;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }

    /* Time Inputs */
    .time-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .time-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }

    .time-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    input[type="time"] {
      padding: 0.35rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.95rem;
      color: var(--text);
      background: white;
      cursor: pointer;
      width: 110px;
    }

    input[type="time"]:focus {
      outline: 2px solid var(--primary);
      border-color: var(--primary);
    }

    /* Visual Bar */
    .visual-bar-container {
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      position: relative;
      margin-top: 0.25rem;
      overflow: hidden;
    }

    .visual-bar-fill {
      position: absolute;
      top: 0;
      bottom: 0;
      background: var(--secondary);
      border-radius: 3px;
      transition: all 0.3s ease;
      -webkit-print-color-adjust: exact;
      /* Force color print */
      print-color-adjust: exact;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .pill-btn {
      font-size: 0.7rem;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      color: var(--text-light);
    }

    .pill-btn:hover {
      border-color: var(--secondary);
      color: var(--secondary);
      background: var(--secondary-light);
    }

    /* Buttons */
    .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-danger {
      background: #fee2e2;
      color: #ef4444;
    }

    .btn-danger:hover {
      background: #fecaca;
    }

    .btn-icon {
      padding: 0.4rem;
      border-radius: 6px;
      background: transparent;
      color: var(--text-light);
      border: 1px solid transparent;
      cursor: pointer;
    }

    .btn-icon:hover {
      background: #fee2e2;
      color: #ef4444;
      border-color: #fecaca;
    }

    /* FAB */
    .fab-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      z-index: 100;
    }

    .fab {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .fab:hover {
      transform: scale(1.1);
    }

    .fab.secondary {
      background: white;
      color: var(--text);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .fab.danger {
      background: #dc2626;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    }

    /* Indicator */
    .indicator-box {
      margin-top: 2rem;
      padding: 1rem;
      border-radius: var(--radius);
      text-align: center;
      font-weight: 600;
    }

    .indicator-box.ok {
      background: #dcfce7;
      color: #166534;
    }

    .indicator-box.warn {
      background: #fef9c3;
      color: #854d0e;
    }

    .indicator-box.bad {
      background: #fee2e2;
      color: #991b1b;
    }

    /* --- PRINT STYLES (2-Columns Compact) --- */
    @media print {
      @page {
        margin: 10mm;
        size: portrait;
      }

      body {
        background: white;
        padding: 0;
        font-size: 10px;
        -webkit-print-color-adjust: exact;
      }

      .container {
        max-width: 100%;
        margin: 0;
        width: 100%;
      }

      /* Hide UI elements */
      .fab-container,
      .view-controls,
      .quick-actions,
      .btn,
      .btn-icon,
      .config-group button,
      .config-bar,
      .chevron,
      .day-summary {
        display: none !important;
      }

      /* Header Stats: Compact Row */
      .header-stats {
        display: flex;
        justify-content: space-between;
        border-bottom: 2px solid #000;
        padding-bottom: 5px;
        margin-bottom: 10px;
        gap: 20px;
      }

      .stat-box {
        border: none;
        box-shadow: none;
        padding: 0;
        background: transparent;
        text-align: left;
        display: flex;
        align-items: baseline;
        gap: 5px;
      }

      .stat-label {
        font-size: 10px;
        color: #000;
        margin-bottom: 0;
      }

      .stat-val {
        font-size: 12px;
        color: #000;
        margin-top: 0;
      }

      /* 2-COLUMN GRID LAYOUT */
      #days-container {
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      /* Day Card: Compact */
      .day-card {
        box-shadow: none;
        border: 1px solid #ccc;
        margin-bottom: 0;
        /* Margin handled by grid gap */
        break-inside: avoid;
        border-radius: 4px;
      }

      .day-header {
        background: #f3f4f6;
        border-bottom: 1px solid #ccc;
        padding: 4px 8px;
        min-height: auto;
      }

      .day-title {
        font-size: 11px;
      }

      .day-fraction {
        font-size: 9px;
        padding: 1px 3px;
      }

      /* Stack Matin/PM vertically inside the narrow column */
      .day-body {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 5px;
        padding: 5px;
        background: white;
        border: none;
      }

      /* Period Block */
      .period-block {
        gap: 2px;
        border-bottom: 1px dashed #eee;
        padding-bottom: 4px;
      }

      .period-block:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .period-title {
        font-size: 9px;
        padding-bottom: 1px;
        margin-bottom: 1px;
        border-bottom: none;
        font-weight: 800;
      }

      /* Time Rows */
      .time-row {
        gap: 5px;
        justify-content: flex-start;
      }

      .time-label {
        font-size: 9px;
        width: 30px;
      }

      .time-group {
        gap: 2px;
      }

      /* Inputs as Text */
      input[type="time"] {
        border: none;
        background: transparent;
        padding: 0;
        width: auto;
        font-size: 10px;
        font-weight: 600;
        color: #000;
        appearance: none;
      }

      input[type="time"]::-webkit-calendar-picker-indicator {
        display: none;
      }

      .visual-bar-container {
        display: none !important;
      }

      .indicator-box {
        border: 1px solid #000;
        background: white !important;
        color: black !important;
        padding: 5px;
        margin-top: 10px;
        font-size: 10px;
      }

      div[style*="height: 120px"] {
        display: none;
      }
    }
  </style>
</head>

<body>

  <div class="container">

    <div class="header-stats">
      <div class="stat-box">
        <div class="stat-label">Théorique</div>
        <div class="stat-val" id="val-theoretical">0.00h</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Réalisé</div>
        <div class="stat-val" id="val-realized">0.00h</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Terrain</div>
        <div class="stat-val terrain" id="val-terrain">0.00h</div>
      </div>
    </div>

    <div class="config-bar">
      <div class="config-group">
        <label style="font-weight:600">Jours d'audit :</label>
        <input type="number" id="totalDays" class="config-input" value="2.75" step="0.25" min="0">
      </div>
      <div class="config-group">
        <button class="btn btn-primary" onclick="app.loadSmartModel()">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Générer Planning
        </button>
        <button class="btn btn-danger" onclick="app.reset()">Reset</button>
      </div>
    </div>

    <div class="view-controls">
      <button class="text-btn" onclick="app.toggleAll(true)">+ Tout Ouvrir</button>
      <button class="text-btn" onclick="app.toggleAll(false)">- Tout Fermer</button>
    </div>

    <div id="days-container"></div>

    <div id="global-indicator" class="indicator-box ok" style="display:none"></div>

    <div style="height: 120px;"></div>
  </div>

  <div class="fab-container">
    <button class="fab danger" onclick="app.exportPDF()" title="Imprimer / PDF">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path
          d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
        </path>
      </svg>
    </button>
    <button class="fab secondary" onclick="app.exportExcel()" title="Export Excel">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
      </svg>
    </button>
    <button class="fab" onclick="app.addDay(1)" title="Ajouter Journée">
      <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M12 4v16m8-8H4"></path>
      </svg>
    </button>
  </div>

  <script>
    const app = (() => {
      let state = { days: [] };

      // --- UTILS ---
      const timeToDec = t => {
        if (!t) return null;
        const [h, m] = t.split(':').map(Number);
        return h + m / 60;
      };
      const decToTime = d => {
        if (d === null || isNaN(d)) return "";
        const h = Math.floor(d);
        const m = Math.round((d - h) * 60);
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      };
      const duration = (s, e) => {
        const start = timeToDec(s);
        const end = timeToDec(e);
        if (start === null || end === null) return 0;
        return Math.max(0, end - start);
      };

      // --- LOGIC ---
      const createDay = (fraction = 1, isOpen = true) => ({
        id: Date.now() + Math.random(),
        fraction,
        isOpen,
        amStart: "", amEnd: "", amTerrainStart: "", amTerrainEnd: "",
        pmStart: "", pmEnd: "", pmTerrainStart: "", pmTerrainEnd: ""
      });

      const calculate = () => {
        let totalAudit = 0, totalTerrain = 0;
        state.days.forEach(d => {
          d.amDur = duration(d.amStart, d.amEnd);
          d.pmDur = duration(d.pmStart, d.pmEnd);
          d.amTerrainDur = duration(d.amTerrainStart, d.amTerrainEnd);
          d.pmTerrainDur = duration(d.pmTerrainStart, d.pmTerrainEnd);
          totalAudit += d.amDur + d.pmDur;
          totalTerrain += d.amTerrainDur + d.pmTerrainDur;
        });
        return { totalAudit, totalTerrain };
      };

      // --- SMART GENERATOR ---
      const loadSmartModel = () => {
        const n = parseFloat(document.getElementById('totalDays').value) || 0;
        if (n <= 0) return;
        if (state.days.length > 0 && !confirm("Cela va remplacer le planning actuel. Continuer ?")) return;

        state.days = [];
        let remainingHours = n * 8;
        let dayCount = 1;

        while (remainingHours > 0.01) { // Epsilon for float comparison
          const dayHours = Math.min(8, remainingHours);
          const day = createDay(dayHours / 8, true); // Open by default

          // Fill AM
          const amHours = Math.min(4, dayHours);
          day.amStart = "08:30";
          day.amEnd = decToTime(8.5 + amHours);

          // Default Terrain AM (50%)
          if (amHours > 0) {
            const tDur = amHours * 0.5;
            const tStart = 8.5 + (amHours - tDur) / 2;
            day.amTerrainStart = decToTime(tStart);
            day.amTerrainEnd = decToTime(tStart + tDur);
          }

          // Fill PM if needed
          if (dayHours > 4) {
            const pmHours = dayHours - 4;
            day.pmStart = "13:30";
            day.pmEnd = decToTime(13.5 + pmHours);

            // Default Terrain PM (50%)
            const tDur = pmHours * 0.5;
            const tStart = 13.5 + (pmHours - tDur) / 2;
            day.pmTerrainStart = decToTime(tStart);
            day.pmTerrainEnd = decToTime(tStart + tDur);
          }

          state.days.push(day);
          remainingHours -= dayHours;
          dayCount++;
        }

        render();
      };

      // --- RENDER ---
      const render = () => {
        const container = document.getElementById('days-container');
        container.innerHTML = "";

        const { totalAudit, totalTerrain } = calculate();
        const theoretical = (parseFloat(document.getElementById('totalDays').value) || 0) * 8;

        // Stats & Validation
        const realizedBox = document.getElementById('val-realized').parentElement;
        const realizedVal = document.getElementById('val-realized');

        document.getElementById('val-theoretical').textContent = theoretical.toFixed(2) + "h";
        realizedVal.textContent = totalAudit.toFixed(2) + "h";
        document.getElementById('val-terrain').textContent = totalTerrain.toFixed(2) + "h";

        // Validation Logic
        const diff = totalAudit - theoretical;
        realizedBox.className = 'stat-box'; // Reset
        if (Math.abs(diff) < 0.1) {
          realizedBox.classList.add('success');
        } else {
          realizedBox.classList.add('error');
          // Append diff text
          const diffDiv = document.createElement('div');
          diffDiv.style.fontSize = '0.8rem';
          diffDiv.style.fontWeight = '600';
          diffDiv.style.marginTop = '0.2rem';
          diffDiv.textContent = `Écart: ${diff > 0 ? '+' : ''}${diff.toFixed(2)}h`;
          realizedVal.appendChild(diffDiv);
        }

        // Global Indicator
        const ind = document.getElementById('global-indicator');
        if (totalAudit > 0) {
          const pct = (totalTerrain / totalAudit) * 100;
          ind.style.display = 'block';
          ind.innerHTML = `Temps Terrain : ${pct.toFixed(1)}% (Cible : 50%)`;
          ind.className = `indicator-box ${pct >= 50 ? 'ok' : (pct >= 45 ? 'warn' : 'bad')}`;
        } else {
          ind.style.display = 'none';
        }

        // Cards
        state.days.forEach((day, idx) => {
          const dayTotal = (day.amDur + day.pmDur).toFixed(2);
          const terrainTotal = (day.amTerrainDur + day.pmTerrainDur).toFixed(2);

          const card = document.createElement('div');
          card.className = `day-card ${day.isOpen ? 'open' : ''}`;
          card.innerHTML = `
        <div class="day-header" onclick="app.toggleDay(${idx})">
          <div class="day-title-group">
            <div class="day-title">Jour ${idx + 1}</div>
            <div class="day-fraction">${day.fraction.toFixed(2)}j</div>
          </div>
          <div style="display:flex;align-items:center">
            <div class="day-summary" ${day.isOpen ? 'style="display:none"' : ''}>
              <span>Audit: <strong>${dayTotal}h</strong></span>
              <span>Terrain: <strong>${terrainTotal}h</strong></span>
            </div>
            <svg class="chevron" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
          </div>
        </div>
        <div class="day-body">
          ${renderPeriod(idx, day, 'am', 'Matin')}
          ${renderPeriod(idx, day, 'pm', 'Après-midi')}
          <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; border-top:1px solid #eee; padding-top:1rem;">
             <button class="btn-icon" onclick="event.stopPropagation(); app.removeDay(${idx})" title="Supprimer Journée">
               <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
               Supprimer
             </button>
          </div>
        </div>
      `;
          container.appendChild(card);
        });

        save();
      };

      const renderPeriod = (idx, day, p, label) => {
        const auditStart = day[`${p}Start`];
        const auditEnd = day[`${p}End`];
        const tStart = day[`${p}TerrainStart`];
        const tEnd = day[`${p}TerrainEnd`];
        const durAudit = day[`${p}Dur`];
        const durTerrain = day[`${p}TerrainDur`];

        // Bar calc
        let barLeft = 0, barWidth = 0;
        if (durAudit > 0 && durTerrain > 0) {
          const startDec = timeToDec(auditStart);
          const tStartDec = timeToDec(tStart);
          if (startDec !== null && tStartDec !== null) {
            barLeft = Math.max(0, ((tStartDec - startDec) / durAudit) * 100);
            barWidth = Math.min(100 - barLeft, (durTerrain / durAudit) * 100);
          }
        }

        return `
      <div class="period-block">
        <div class="period-title">
          <span>${label}</span>
          <span>${durAudit.toFixed(2)}h</span>
        </div>
        
        <div class="time-row">
          <span class="time-label">Audit</span>
          <div class="time-group">
            <input type="time" value="${auditStart}" onchange="app.update(${idx}, '${p}Start', this.value)">
            <span style="color:#94a3b8">à</span>
            <input type="time" value="${auditEnd}" onchange="app.update(${idx}, '${p}End', this.value)">
            <button class="btn-icon" onclick="app.resetPeriod(${idx}, '${p}')" title="Standard (08:30-12:30 / 13:30-17:30)">
               <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            </button>
            <button class="btn-icon" onclick="app.clearPeriod(${idx}, '${p}')" title="Vider">
               <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
        </div>

        <div class="time-row">
          <span class="time-label" style="color:var(--secondary)">Terrain</span>
          <div class="time-group">
            <input type="time" value="${tStart}" onchange="app.update(${idx}, '${p}TerrainStart', this.value)">
            <span style="color:#94a3b8">à</span>
            <input type="time" value="${tEnd}" onchange="app.update(${idx}, '${p}TerrainEnd', this.value)">
          </div>
        </div>

        <div class="visual-bar-container">
          <div class="visual-bar-fill" style="left:${barLeft}%; width:${barWidth}%"></div>
        </div>
        
        <div class="quick-actions">
          <button class="pill-btn" onclick="app.fillTerrain(${idx}, '${p}', 1)">100%</button>
          <button class="pill-btn" onclick="app.fillTerrain(${idx}, '${p}', 0.5)">50%</button>
          <button class="pill-btn" onclick="app.fillTerrain(${idx}, '${p}', 0)">Vider</button>
        </div>
      </div>
    `;
      };

      // --- ACTIONS ---
      const update = (idx, key, val) => { state.days[idx][key] = val; render(); };
      const addDay = (frac) => { state.days.push(createDay(frac, true)); render(); };
      const removeDay = (idx) => { if (confirm('Supprimer ?')) { state.days.splice(idx, 1); render(); } };

      const toggleDay = (idx) => {
        state.days[idx].isOpen = !state.days[idx].isOpen;
        render();
      };

      const toggleAll = (open) => {
        state.days.forEach(d => d.isOpen = open);
        render();
      };

      const fillTerrain = (idx, p, ratio) => {
        const d = state.days[idx];
        const s = timeToDec(d[`${p}Start`]);
        const e = timeToDec(d[`${p}End`]);
        if (s === null || e === null) return;
        const dur = e - s;
        if (dur <= 0) return;

        if (ratio === 0) {
          d[`${p}TerrainStart`] = ""; d[`${p}TerrainEnd`] = "";
        } else {
          const tDur = dur * ratio;
          const margin = (dur - tDur) / 2;
          d[`${p}TerrainStart`] = decToTime(s + margin);
          d[`${p}TerrainEnd`] = decToTime(e - margin);
        }
        render();
      };

      const clearPeriod = (idx, p) => {
        const d = state.days[idx];
        d[`${p}Start`] = ""; d[`${p}End`] = "";
        d[`${p}TerrainStart`] = ""; d[`${p}TerrainEnd`] = "";
        render();
      };

      const resetPeriod = (idx, p) => {
        const d = state.days[idx];
        if (p === 'am') { d.amStart = "08:30"; d.amEnd = "12:30"; }
        else { d.pmStart = "13:30"; d.pmEnd = "17:30"; }
        d[`${p}TerrainStart`] = ""; d[`${p}TerrainEnd`] = "";
        render();
      };

      const reset = () => { if (confirm("Tout effacer ?")) { state.days = []; render(); } };

      const validateDuration = () => {
        const { totalAudit } = calculate();
        const theoretical = (parseFloat(document.getElementById('totalDays').value) || 0) * 8;
        const diff = totalAudit - theoretical;
        if (Math.abs(diff) > 0.1) {
          return confirm(`⚠️ Attention : Écart de durée détecté !\n\nThéorique : ${theoretical.toFixed(2)}h\nRéalisé : ${totalAudit.toFixed(2)}h\nÉcart : ${diff > 0 ? '+' : ''}${diff.toFixed(2)}h\n\nVoulez-vous quand même exporter ?`);
        }
        return true;
      };

      const exportExcel = () => {
        if (!validateDuration()) return;

        const rows = [];
        state.days.forEach((d, i) => {
          rows.push([
            `Jour ${i + 1}`,
            d.amStart, d.amEnd, d.amTerrainStart, d.amTerrainEnd,
            d.pmStart, d.pmEnd, d.pmTerrainStart, d.pmTerrainEnd,
            (d.amDur + d.pmDur).toFixed(2),
            (d.amTerrainDur + d.pmTerrainDur).toFixed(2)
          ]);
        });
        const ws = XLSX.utils.aoa_to_sheet([
          ['Jour', 'Matin Début', 'Matin Fin', 'Terrain Début', 'Terrain Fin', 'AM Début', 'AM Fin', 'Terrain Début', 'Terrain Fin', 'Total Audit', 'Total Terrain'],
          ...rows
        ]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Planning");
        XLSX.writeFile(wb, "Planning_Audit.xlsx");
      };

      const exportPDF = () => {
        if (!validateDuration()) return;

        // Force open all for printing
        const oldState = state.days.map(d => d.isOpen);
        toggleAll(true);

        // Print
        window.print();

        // Restore state (optional, but nice)
        // We use a small timeout to let the print dialog open before restoring
        setTimeout(() => {
          state.days.forEach((d, i) => d.isOpen = oldState[i]);
          render();
        }, 500);
      };

      // --- PERSISTENCE ---
      const save = () => {
        localStorage.setItem('audit_v3_data', JSON.stringify(state));
        localStorage.setItem('audit_v3_days', document.getElementById('totalDays').value);
      };

      const init = () => {
        const savedDays = localStorage.getItem('audit_v3_days');
        if (savedDays) document.getElementById('totalDays').value = savedDays;

        const saved = localStorage.getItem('audit_v3_data');
        if (saved) {
          try { state = JSON.parse(saved); render(); } catch (e) { }
        } else {
          loadSmartModel();
        }
        document.getElementById('totalDays').addEventListener('input', render);
      };

      return { init, update, addDay, removeDay, toggleDay, toggleAll, fillTerrain, clearPeriod, resetPeriod, loadSmartModel, reset, exportExcel, exportPDF };
    })();

    app.init();
  </script>
</body>

</html>